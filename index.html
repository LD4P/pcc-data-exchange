<!DOCTYPE html>
<html>
    <head>
      <link rel="stylesheet" href="https://pyscript.net/alpha/pyscript.css" />
      <link href="static/css/main.css" rel="stylesheet" />
      <link href="static/css/header.css" rel="stylesheet" />

      <script defer src="https://pyscript.net/alpha/pyscript.js"></script>
      <py-env>
        - lxml
        - numpy
        - matplotlib
        - './static/wheels/rdflib-6.1.1-py3-none-any.whl'
        - './static/wheels/pyshacl-0.19.0-py3-none-any.whl'
        - paths:
          - ./src/pcc_data_exchange/data.py
          - ./src/pcc_data_exchange/utils.py
      </py-env>
    </head>

  <body>
    <py-script>
      import json
      import sys
      import datetime as dt

      import js
      from pyodide.http import open_url

      # Hack to load rdflib
      setattr(sys.stderr, 'isatty', lambda : True)

      import pyshacl
      from rdflib import Graph, Namespace

      shacl_urls = [
        'https://api.development.sinopia.io/resource/18b6edba-b829-47f8-9fab-05b00314bc2e',
        'https://api.development.sinopia.io/resource/c3067afb-d255-487c-834b-d40ce0ac075d',
        'https://api.development.sinopia.io/resource/ecea41b3-ce74-4e2f-8a97-299caa46fd74',
        'https://api.development.sinopia.io/resource/9c496dbc-8717-4a17-a8ac-46e25f0f4c71',
        'https://api.development.sinopia.io/resource/0733f929-011a-4865-8c80-ef69449f1a25',
        'https://api.development.sinopia.io/resource/137a8f9d-bee3-410d-b224-aa3712013662' 
      ]
      

      from data import SHACL, init_shacl_graph
      from utils import validation_html

      shacl_graph = init_shacl_graph(shacl_urls)
    
      pyscript.write('today', dt.date.today().strftime('%A %B %d, %Y'))
      pyscript.write('shacl_size', f"{len(shacl_graph)} triples from {len(shacl_urls)} Sinopia SHACL Resources")

      shacl_summary = Element("shacl_summary")
      shacl_summary_template = Element("summary-template").select(".summary", from_content=True)
      shapes = {}


      def summarize(*args, **kwargs):
          shacl_summary.clear()
          current_shacl = kwargs.get("graph", shacl_graph)
          for row in current_shacl.query("""SELECT ?node_shape ?label ?target
          WHERE { ?node_shape a sh:NodeShape .
                  ?node_shape rdfs:label ?label . 
                  ?node_shape sh:targetClass ?target .}
          ORDER BY ?label """):
              key = str(row[0])
              if not key in shapes:
                  shapes[key] = {
                    "id": row[0],
                    "label": str(row[1]),
                    "targets": [row[2],],
                  }
                  continue
              shapes[key]["targets"].append(row[2])
          for key, shape in shapes.items():
              shape_html = shacl_summary_template.clone(key, to=shacl_summary)
              shape_tr = js.document.createElement("tr")
              shape_td = js.document.createElement("td")
              anchor = js.document.createElement("a")
              anchor.setAttribute("href", shape["id"])
              anchor.innerText = shape["label"]
              shape_td.appendChild(anchor)
              shape_tr.appendChild(shape_td)
              target_td = js.document.createElement("td")
              for target_class in shape["targets"]:
                  target_p = js.document.createElement("p")
                  target_p.innerText = target_class
                  target_td.appendChild(target_p)
              shape_tr.appendChild(target_td)
              properties = {}
              for obj in current_shacl.objects(subject=shape["id"],
                                               predicate=SHACL.property):
                path = current_shacl.value(subject=obj, predicate=SHACL.path)
                path_key = str(path)
                if not path_key in properties:
                    properties[path_key] = [("path", str(path))]
                min_count = current_shacl.value(subject=obj, predicate=SHACL.minCount)
                if min_count:
                    properties[path_key].append(("miniumum count", int(min_count)))
              _add_property_summary(properties, shape_tr)
              shacl_summary.element.appendChild(shape_tr)
      
      def _add_property_summary(properties, tr):
          td = js.document.createElement("td")
          unordered_list = js.document.createElement("ul")
          for values in properties.values():
              for row in values:
                  li = js.document.createElement("li")
                  li.innerText = f"{row[0]}: {row[1]}"
                  unordered_list.appendChild(li)
          td.appendChild(unordered_list)
          tr.appendChild(td)

      summarize()


      rdf_url = Element("rdf-url")
      upload_control = Element("upload-rdf")

      async def validate_rdf(*args, **kwargs):
          incoming_graph = Graph()

          if upload_control.element.files.length > 0:
              rdf_file = upload_control.element.files.item(0)
              rdf_file_text = await rdf_file.text()
              incoming_graph.parse(data=rdf_file_text)
              upload_control.clear()
          elif len(rdf_url.value):
              result = open_url(rdf_url.value)
              if "sinopia" in rdf_url.value:
                  sinopia_json_ld = json.loads(result.getvalue())['data']
                  incoming_graph.parse(data=json.dumps(sinopia_json_ld), format='json-ld')
              else: # Try parsing the text
                  raw_rdf = result.getvalue()
                  incoming_graph.parse(data=raw_rdf)
              rdf_url.clear()
          if len(incoming_graph) > 0:
              conforms, results_graph, results_text = pyshacl.validate(incoming_graph, shacl_graph=shacl_graph)
              if conforms is True:
                  pyscript.write('validation-result', f"Passed!\n{results_text}")
              else:
                  validation_html(Element("validation-result"), results_text, results_graph)
              
          

    </py-script>
    <div class="editor-navbar">
      <label id="today"></label>
      <h1>PCC Interchange Processing</h1>
      <label id="shacl_size" class="pull-right"></label>
    </div>

    <h2>Enter URL or upload Source RDF</h2>
    <py-box widths="2/5;2/5;1/5">
      <input id="rdf-url" class="border flex-1 mr-3 border-gray-300 p-2 rounded" type="text"></input>
      <input type="file" id="upload-rdf"></input>
      <button id="validate-rdf-btn" class="btn-primary" pys-onClick="validate_rdf">Validate RDF</button>
    </py-box>
    <div id="validation-result"></div>
    <hr>
    <h2>SHACL Summary</h2>
    <table class="table table-bordered search-results-list">
      <thead>
        <th>Shape Name</th>
        <th>Target Class(es)</th>
        <th>Properties</th>
      </thead>
      <tbody id="shacl_summary">
        <template id="summary-template">
          <section class="summary">
            <tr></tr>
         </section>
        </template>
     </tbody>
    </table>
    <div ></div>
    <h2>Python REPL</h2>
   <py-box widths="1/2;1/2">
        <py-repl id="my-repl" auto-generate="true" std-out="output" std-err="err-div"> </py-repl>
        <div id="output" class="p-4"></div>
    </py-box>
    <hr>
    <footer>
     <div id="err-div" class="bg-red-700 text-white text-center border-t-4 border-green-500 fixed inset-x-0 bottom-0 p-4 hidden"></div>
      <p xmlns:cc="http://creativecommons.org/ns#" >
        This work is licensed under <a href="http://creativecommons.org/licenses/by/4.0/?ref=chooser-v1" 
        target="_blank" 
        rel="license noopener noreferrer" style="display:inline-block;">Creative Commons Attribution 4.0 International</a>.
        Source code licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache 2</a>.
     </p> 
    </footer>
  </body>
</html>
